#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n'


#---------------wallpaper directory config--------------------#

WALL_DIR="$HOME/wallpaper"        # directory containing wallpapers
CWD="$(pwd)"                      # save current working directory


#---------------sanity checks---------------------------------#

# ensure wallpaper directory exists
if [[ ! -d "$WALL_DIR" ]]; then
  echo "Wallpaper directory not found: $WALL_DIR" >&2
  exit 1
fi


#---------------enter wallpaper directory---------------------#

pushd "$WALL_DIR" >/dev/null || exit 1


#---------------collect wallpaper files-----------------------#

# allow empty globs safely
shopt -s nullglob
files=( *.jpg *.jpeg *.png *.JPG *.PNG *.JPEG )
shopt -u nullglob

if [[ ${#files[@]} -eq 0 ]]; then
  echo "No wallpaper files found in $WALL_DIR" >&2
  popd >/dev/null || true
  exit 1
fi


#---------------rofi wallpaper selector-----------------------#

SELECTED_WALL=$(
  printf '%s\n' "${files[@]}" |
  rofi -dmenu -p "Choose wallpaper:"
)

# exit cleanly if nothing selected
if [[ -z "$SELECTED_WALL" ]]; then
  popd >/dev/null || true
  exit 0
fi


#---------------locate wal backend----------------------------#

# prefer PATH, fallback to ~/.local/bin
wal_backend="$(command -v walset-backend || echo "$HOME/.local/bin/walset-backend")"

if [[ ! -x "$wal_backend" ]]; then
  echo "walset-backend not found or not executable: $wal_backend" >&2
  popd >/dev/null || true
  exit 1
fi


#---------------apply wallpaper-------------------------------#

"$wal_backend" "$WALL_DIR/$SELECTED_WALL"


#---------------cleanup & return------------------------------#

popd >/dev/null || true
cd "$CWD" || exit 0

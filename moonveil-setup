#!/bin/bash
set -euo pipefail

#--------------- Moonveil Setup Script ----------------#

SRC="/usr/share/moonveil/dotfiles"
MOONVEIL="$HOME/moonveil"

CFG_SRC="$MOONVEIL/.config"
BIN_SRC="$MOONVEIL/bin"
SHELL_SRC="$MOONVEIL/shell"

WALLPAPER_DIR="$HOME/wallpaper"
WALLPAPER_REPO="https://github.com/notcandy001/my-wal.git"

echo ":: Moonveil setup starting"
echo ":: Source      : $SRC"
echo ":: Destination : $MOONVEIL"
echo

#--------------- Sanity Check ----------------#
if [ ! -d "$SRC" ]; then
  echo "ERROR: Moonveil is not installed."
  echo "Install it first: yay -S moonveil"
  exit 1
fi

#--------------- Initialize ~/moonveil ----------------#
if [ ! -d "$MOONVEIL" ]; then
  echo ":: Creating ~/moonveil"
  mkdir -p "$MOONVEIL"
  cp -r "$SRC"/. "$MOONVEIL/"
else
  echo ":: ~/moonveil already exists"
fi

mkdir -p "$HOME/.config" "$HOME/.local/bin"

#--------------- Symlink ~/.config ----------------#
echo ":: Linking .config directories"

if [ -d "$CFG_SRC" ]; then
  for dir in "$CFG_SRC"/*; do
    [ -d "$dir" ] || continue
    ln -sfn "$dir" "$HOME/.config/$(basename "$dir")"
  done
fi

#--------------- Symlink ~/.local/bin ----------------#
echo ":: Linking bin files and folders (INCLUDING moonbar + theme)"

if [ -d "$BIN_SRC" ]; then
  for item in "$BIN_SRC"/*; do
    name="$(basename "$item")"
    ln -sfn "$item" "$HOME/.local/bin/$name"
    [ -f "$item" ] && chmod +x "$item"
  done
fi

#--------------- Shell Configs ----------------#
echo ":: Linking shell configs"

[ -f "$SHELL_SRC/zshrc" ] && ln -sfn "$SHELL_SRC/zshrc" "$HOME/.zshrc"
[ -f "$SHELL_SRC/p10k.zsh" ] && ln -sfn "$SHELL_SRC/p10k.zsh" "$HOME/.p10k.zsh"

#--------------- Wallpaper ----------------#
echo ":: Setting up wallpapers"

if [ -d "$WALLPAPER_DIR/.git" ]; then
  git -C "$WALLPAPER_DIR" pull --quiet
else
  git clone --depth=1 "$WALLPAPER_REPO" "$WALLPAPER_DIR"
fi

echo
echo ":: Moonveil setup complete"
echo ":: Restart your shell or log out"

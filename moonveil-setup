#!/bin/bash
set -e

# ==========================================
# Moonveil Setup (AUR + Home-based)
# ==========================================

SRC="/usr/share/moonveil/dotfiles"
MOONVEIL="$HOME/moonveil"

CFG_SRC="$MOONVEIL/.config"
BIN_SRC="$MOONVEIL/bin"
SHELL_SRC="$MOONVEIL/shell"

BACKUP="$HOME/.config/moonveil-backup-$(date +%s)"

echo ":: Moonveil setup starting"
echo ":: Moonveil directory: $MOONVEIL"

# ----------------------------------
# Validate installation
# ----------------------------------
if [ ! -d "$SRC" ]; then
  echo "ERROR: Moonveil is not installed."
  echo "Install via AUR: yay -S moonveil"
  exit 1
fi

# ----------------------------------
# Initialize ~/moonveil
# ----------------------------------
if [ ! -d "$MOONVEIL" ]; then
  echo ":: Creating ~/moonveil"
  mkdir -p "$MOONVEIL"
  cp -r "$SRC"/. "$MOONVEIL/"
else
  echo ":: ~/moonveil already exists"
fi

mkdir -p "$HOME/.config" "$HOME/.local/bin" "$BACKUP"

# ----------------------------------
# Symlink ~/.config/*
# ----------------------------------
find "$CFG_SRC" -mindepth 1 -maxdepth 1 -type d | while read -r dir; do
  name="$(basename "$dir")"

  if [ -e "$HOME/.config/$name" ] && [ ! -L "$HOME/.config/$name" ]; then
    echo ":: Backing up $name"
    mv "$HOME/.config/$name" "$BACKUP/"
  fi

  ln -sfn "$dir" "$HOME/.config/$name"
done

# ----------------------------------
# Symlink ~/.local/bin/*
# ----------------------------------
ln -sfn "$BIN_SRC"/* "$HOME/.local/bin/" 2>/dev/null || true

# ----------------------------------
# Shell configs
# ----------------------------------
[ -f "$SHELL_SRC/zshrc" ] && ln -sfn "$SHELL_SRC/zshrc" "$HOME/.zshrc"
[ -f "$SHELL_SRC/p10k.zsh" ] && ln -sfn "$SHELL_SRC/p10k.zsh" "$HOME/.p10k.zsh"

echo ":: Moonveil setup complete"
echo ":: Restart shell or log out"

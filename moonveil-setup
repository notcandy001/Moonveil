#!/bin/bash
set -euo pipefail

#---------------Moonveil Setup Script-------------------#

SRC="/usr/share/moonveil/dotfiles"
MOONVEIL="$HOME/moonveil"

CFG_SRC="$MOONVEIL/.config"
BIN_SRC="$MOONVEIL/bin"
SHELL_SRC="$MOONVEIL/shell"

WALLPAPER_DIR="$HOME/wallpaper"
WALLPAPER_REPO="https://github.com/notcandy001/my-wal.git"

BACKUP="$HOME/.config/moonveil-backup-$(date +%s)"

echo ":: Moonveil setup starting"
echo ":: Source      : $SRC"
echo ":: Destination : $MOONVEIL"
echo ":: Backup dir  : $BACKUP"
echo

#---------------Sanity Check-------------------#
if [ ! -d "$SRC" ]; then
  echo "ERROR: Moonveil is not installed."
  echo "Install it first: yay -S moonveil"
  exit 1
fi

#---------------Initialize ~/moonveil-------------------#
if [ ! -d "$MOONVEIL" ]; then
  echo ":: Creating ~/moonveil"
  mkdir -p "$MOONVEIL"
  cp -r "$SRC"/. "$MOONVEIL/"
else
  echo ":: ~/moonveil already exists"
fi

mkdir -p "$HOME/.config" "$HOME/.local/bin" "$BACKUP"

#---------------Symlink ~/.config/*-------------------#
echo ":: Linking .config directories"

if [ -d "$CFG_SRC" ]; then
  for dir in "$CFG_SRC"/*; do
    [ -d "$dir" ] || continue
    name="$(basename "$dir")"

    if [ -e "$HOME/.config/$name" ] && [ ! -L "$HOME/.config/$name" ]; then
      echo "   ↳ Backing up $name"
      mv "$HOME/.config/$name" "$BACKUP/"
    fi

    ln -sfn "$dir" "$HOME/.config/$name"
  done
fi

#---------------Symlink ~/.local/bin/*-------------------#
echo ":: Linking bin scripts"

if [ -d "$BIN_SRC" ]; then
  for file in "$BIN_SRC"/*; do
    [ -f "$file" ] || continue
    chmod +x "$file"
    ln -sfn "$file" "$HOME/.local/bin/$(basename "$file")"
  done
fi

#---------------Symlink Shell Configs-------------------#
echo ":: Linking shell configs"

if [ -f "$SHELL_SRC/zshrc" ]; then
  ln -sfn "$SHELL_SRC/zshrc" "$HOME/.zshrc"
fi

if [ -f "$SHELL_SRC/p10k.zsh" ]; then
  ln -sfn "$SHELL_SRC/p10k.zsh" "$HOME/.p10k.zsh"
fi

#---------------Wallpaper-------------------#
echo ":: Setting up wallpapers"

if [ -d "$WALLPAPER_DIR/.git" ]; then
  echo "   ↳ Updating wallpaper collection"
  git -C "$WALLPAPER_DIR" pull --quiet
else
  echo "   ↳ Cloning wallpaper collection to ~/wallpaper"
  git clone --depth=1 "$WALLPAPER_REPO" "$WALLPAPER_DIR"
fi

echo
echo ":: Moonveil setup complete"
echo ":: Restart your shell or log out"

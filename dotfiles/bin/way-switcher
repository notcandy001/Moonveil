#!/usr/bin/env bash

WAYBAR="$HOME/.config/waybar"
THEMES="$WAYBAR/themes"
STATE="$HOME/.cache/waybar-current"


mkdir -p "$(dirname "$STATE")"


launch_moonbar() {
  kill_moonbar
  pkill -x waybar 2>/dev/null

  nohup "$MOONBAR_CMD" >/dev/null 2>&1 &
  disown
}

CURRENT=""


elif [[ -f "$STATE" ]]; then
  IFS="|" read -r CUR_CFG CUR_CSS < "$STATE"
  if [[ "$CUR_CFG" == "$WAYBAR/config.jsonc" ]]; then
    CURRENT="Main"
  else
    CURRENT="$(basename "$(dirname "$CUR_CFG")")"
  fi
fi

THEME_LIST=""

add_item() {
  [[ "$1" == "$CURRENT" ]] && THEME_LIST+="$1 [in use]\n" || THEME_LIST+="$1\n"
}

add_item "Main"

if [[ -d "$THEMES" ]]; then
  for dir in "$THEMES"/*; do
    [[ -d "$dir" ]] && add_item "$(basename "$dir")"
  done
fi

add_item "Moonbar"

CHOICE=$(printf "%b" "$THEME_LIST" | rofi -dmenu -p "Bar")
[[ -z "$CHOICE" ]] && exit 0
CHOICE="${CHOICE%% *}"

if [[ "$CHOICE" == "Moonbar" ]]; then
  echo "Moonbar" > "$STATE"
  launch_moonbar
  exit 0
fi

CFG=""
CSS=""

if [[ "$CHOICE" == "Main" ]]; then
  CFG="$WAYBAR/config.jsonc"
  CSS="$WAYBAR/style.css"
else
  CFG="$THEMES/$CHOICE/config.jsonc"
  CSS="$THEMES/$CHOICE/style.css"
fi

if [[ ! -f "$CFG" || ! -f "$CSS" ]]; then
  notify-send "Waybar" "Theme '$CHOICE' is missing config or style"
  exit 1
fi

kill_moonbar
pkill -x waybar
sleep 0.4

echo "$CFG|$CSS" > "$STATE"
waybar -c "$CFG" -s "$CSS" &

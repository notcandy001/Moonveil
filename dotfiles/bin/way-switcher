#!/usr/bin/env bash

#---------------waybar paths----------------------------------#
WAYBAR="$HOME/.config/waybar"
THEMES="$WAYBAR/themes"
STATE="$HOME/.cache/waybar-current"


#---------------detect current theme--------------------------#
CURRENT=""

if [[ -f "$STATE" ]]; then
  IFS="|" read -r CUR_CFG CUR_CSS < "$STATE"

  if [[ "$CUR_CFG" == "$WAYBAR/config.jsonc" ]]; then
    CURRENT="Main"
  else
    CURRENT="$(basename "$(dirname "$CUR_CFG")")"
  fi
fi


#---------------build rofi list-------------------------------#
THEME_LIST=""

add_item() {
  local name="$1"
  if [[ "$name" == "$CURRENT" ]]; then
    THEME_LIST+="$name [in use]\n"
  else
    THEME_LIST+="$name\n"
  fi
}

# Main theme
add_item "Main"

# Auto-detect themes
if [[ -d "$THEMES" ]]; then
  for dir in "$THEMES"/*; do
    [[ -d "$dir" ]] && add_item "$(basename "$dir")"
  done
fi


#---------------rofi selector---------------------------------#
CHOICE=$(printf "%b" "$THEME_LIST" | rofi -dmenu -p "Waybar")

[[ -z "$CHOICE" ]] && exit 0

# Clean selection
CHOICE="${CHOICE%% *}"


#---------------select config---------------------------------#
if [[ "$CHOICE" == "Main" ]]; then
  CFG="$WAYBAR/config.jsonc"
  CSS="$WAYBAR/style.css"
else
  CFG="$THEMES/$CHOICE/config.jsonc"
  CSS="$THEMES/$CHOICE/style.css"

  if [[ ! -f "$CFG" || ! -f "$CSS" ]]; then
    notify-send "Waybar" "Theme '$CHOICE' is missing config or style"
    exit 1
  fi
fi


#---------------save current state----------------------------#
echo "$CFG|$CSS" > "$STATE"


#---------------restart waybar--------------------------------#
pkill -x waybar
sleep 0.4
waybar -c "$CFG" -s "$CSS" &

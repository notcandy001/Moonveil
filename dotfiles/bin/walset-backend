#!/usr/bin/env bash
set -euo pipefail

#——— binaries ————————————————————————————
MATUGEN="$(command -v matugen || true)"
SWWW="$(command -v swww || true)"
HYPRCTL="$(command -v hyprctl || true)"
NOTIFY="$(command -v notify-send || true)"
MOONBAR_RUN="$HOME/.local/bin/moonbar-run"

#——— process names ——————————————————————
MOONBAR_PROC="moonshell"

#——— config paths ——————————————————————
MATUGEN_CONFIG="$HOME/.config/matugen/matugen.toml"

WAYBAR_COLORS="$HOME/.config/waybar/colors.css"
ROFI_COLORS="$HOME/.config/rofi/colors.rasi"
HYPR_COLORS="$HOME/.config/hypr/colors.conf"
HYPRLOCK_COLORS="$HOME/.config/hypr/colors.conf"
SWAYNC_COLORS="$HOME/.config/swaync/colors.css"
GTK_COLORS="$HOME/.config/gtk-3.0/colors.css"

#——— cache & logs ——————————————————————
CACHE_WALL="$HOME/.cache/current_wallpaper"
LOG_DIR="/tmp/walset-backend"
mkdir -p "$LOG_DIR"

MATUGEN_LOG="$LOG_DIR/matugen.log"
SWWW_LOG="$LOG_DIR/swww.log"

#——— args ——————————————————————————————
if [ "$#" -ne 1 ]; then
  echo "Usage: walset-backend /path/to/image" >&2
  exit 1
fi

IMAGE="$1"
[ -f "$IMAGE" ] || { echo "Image not found: $IMAGE"; exit 1; }

#——— dependency checks ——————————————————
for bin in "$MATUGEN" "$SWWW"; do
  if [ -z "$bin" ]; then
    echo "Missing dependency: $bin" >&2
    exit 1
  fi
done

[ -f "$MATUGEN_CONFIG" ] || {
  echo "Missing matugen config: $MATUGEN_CONFIG" >&2
  exit 1
}

#——— notify start ——————————————————————
[ -n "$NOTIFY" ] && "$NOTIFY" "Moonveil" "Applying wallpaper & theme…"

#——— detect moonbar state —————————————
MOONBAR_WAS_RUNNING=false
if pgrep -x "$MOONBAR_PROC" >/dev/null; then
  MOONBAR_WAS_RUNNING=true
fi

#——— kill moonbar ONLY if running ——————
if [ "$MOONBAR_WAS_RUNNING" = true ]; then
  pkill -x "$MOONBAR_PROC"
  sleep 0.4
fi

#——— apply wallpaper (swww) ———————————
"$SWWW" img "$IMAGE" \
  --transition-type any \
  --transition-fps 60 \
  --transition-step 255 \
  >"$SWWW_LOG" 2>&1 || true

#——— sync wallpaper for lockscreen —————
cp -f "$IMAGE" "$CACHE_WALL"
pkill -USR1 hyprlock 2>/dev/null || true

#——— generate colors (matugen) —————————
"$MATUGEN" image "$IMAGE" \
  -c "$MATUGEN_CONFIG" \
  -v >"$MATUGEN_LOG" 2>&1

#——— validate outputs ——————————————————
for f in \
  "$WAYBAR_COLORS" \
  "$ROFI_COLORS" \
  "$HYPR_COLORS" \
  "$SWAYNC_COLORS" \
  "$GTK_COLORS"
do
  [ -s "$f" ] || echo "WARN: $f missing or empty" >>"$LOG_DIR/warn.log"
done

#——— reload hyprland ——————————————————
[ -x "$HYPRCTL" ] && "$HYPRCTL" reload >/dev/null 2>&1 || true

#——— restart moonbar ONLY if it was running —
if [ "$MOONBAR_WAS_RUNNING" = true ]; then
  nohup "$MOONBAR_RUN" >/dev/null 2>&1 &
fi

#——— notify done ——————————————————————
[ -n "$NOTIFY" ] && "$NOTIFY" "Moonveil" "Wallpaper & colors applied"

exit 0
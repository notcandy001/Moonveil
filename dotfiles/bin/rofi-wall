#!/usr/bin/env bash
set -euo pipefail

# rofi wallpaper picker + wal color applier
#-------------------------------------------------------------#

#---------------path & variable config------------------------#

WALLPAPER_DIR="$HOME/wallpaper"                  # wallpaper source directory
BACKEND="$HOME/.local/bin/walset-backend"        # wallpaper + wal backend
CACHE="$HOME/.cache/rofi-wallpapers"             # thumbnail cache
SIZE=220                                         # must match rofi icon size

mkdir -p "$CACHE"

#---------------thumbnail generation--------------------------#

# supported formats (including gif)
shopt -s nullglob
IMAGES=("$WALLPAPER_DIR"/*.{jpg,jpeg,png,webp,gif})
shopt -u nullglob

for img in "${IMAGES[@]}"; do
  name="$(basename "$img")"
  thumb="$CACHE/$name.png"

  # create thumbnail once
  if [ ! -f "$thumb" ]; then
    if [[ "$img" == *.gif ]]; then
      # take FIRST FRAME of gif
      magick "$img[0]" \
        -resize ${SIZE}x${SIZE}^ \
        -gravity center \
        -extent ${SIZE}x${SIZE} \
        "$thumb"
    else
      magick "$img" \
        -resize ${SIZE}x${SIZE}^ \
        -gravity center \
        -extent ${SIZE}x${SIZE} \
        "$thumb"
    fi
  fi
done

#---------------rofi wallpaper menu---------------------------#

CHOICE=$(
  for img in "${IMAGES[@]}"; do
    name="$(basename "$img")"
    printf '%s\0icon\x1f%s\n' "$name" "$CACHE/$name.png"
  done | rofi -dmenu \
        -show-icons \
        -theme "$HOME/.config/rofi/themes/wallpaper-grid.rasi" \
        -p "Select wallpaper"
)

[ -z "$CHOICE" ] && exit 0

#---------------apply wallpaper-------------------------------#

exec "$BACKEND" "$WALLPAPER_DIR/$CHOICE"

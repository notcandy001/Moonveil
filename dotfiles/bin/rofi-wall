#!/usr/bin/env bash
set -euo pipefail

# rofi wallpaper picker + wal color applier
#-------------------------------------------------------------#


#---------------path & variable config------------------------#

WALLPAPER_DIR="$HOME/wallpaper"                  # wallpaper source directory
BACKEND="$HOME/.local/bin/walset-backend"        # wallpaper + wal backend
CACHE="$HOME/.cache/rofi-wallpapers"             # thumbnail cache
SIZE=220                                         # must match rofi icon size

mkdir -p "$CACHE"


#---------------thumbnail generation--------------------------#

# creates true square thumbnails for rofi grid
for img in "$WALLPAPER_DIR"/*.{jpg,jpeg,png,webp}; do
  [ -f "$img" ] || continue

  name="$(basename "$img")"
  thumb="$CACHE/$name"

  if [ ! -f "$thumb" ]; then
    magick "$img" \
      -resize ${SIZE}x${SIZE}^ \
      -gravity center \
      -extent ${SIZE}x${SIZE} \
      "$thumb"
  fi
done


#---------------rofi wallpaper menu---------------------------#

CHOICE=$(
  for img in "$WALLPAPER_DIR"/*.{jpg,jpeg,png,webp}; do
    [ -f "$img" ] || continue
    name="$(basename "$img")"
    printf '%s\0icon\x1f%s\n' "$name" "$CACHE/$name"
  done | rofi -dmenu \
        -show-icons \
        -theme "$HOME/.config/rofi/themes/wallpaper-grid.rasi" \
        -p "Select wallpaper"
)

[ -z "$CHOICE" ] && exit 0


#---------------apply wallpaper-------------------------------#

exec "$BACKEND" "$WALLPAPER_DIR/$CHOICE"
